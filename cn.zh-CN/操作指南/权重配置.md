权重配置 
=========================



概述 
-----------------------

云解析DNS权重配置，指在DNS服务器中为同一个主机记录配置多个IP地址，在应答DNS查询时，所有IP地址按照预先设置的权重进行返回不同的解析结果，将解析流量分配到不同的服务器上，从而达到负载均衡的目的。

启用条件 
-------------------------

权重配置的启用条件是域名下存在相同的主机记录、相同解析线路的多条A记录、CNAME记录、AAAA记录。

规则限制 
-------------------------

权重配置仅适用于记录类型为"A记录、CNAME记录、AAAA记录"，且是 **相同主机记录** 、 **相同线路** 下的\*\*多个记录值。具体使用规则如下：


|    限制    |                                         支持                                          |               不支持                |
|----------|-------------------------------------------------------------------------------------|----------------------------------|
| 记录类型     | A记录、CNAME记录、AAAA记录                                                                  | 其他记录类型                           |
| 记录状态     | 出于 **启用** 状态的记录                                                                     | 处于 **暂停** 、 **锁定** 状态的记录，以及泛解析记录 |
| 解析记录数量限制 | 单域名单线路下允许配置权重的最大解析记录数量：免费版支持10个，付费版支持90个。                                           | ---------                        |
| 权重值规则    | 权重值允许设置0-100，默认权重值比例为1:1 . 支持权重值设置为 "0"，则云解析DNS不返回此解析记录值。                           | ---------                        |
| 解析线路     | 可对默认线路配置带权重的A记录，也可以对具体的线路配置。 **说明**  不同线路中，其权重相互独立。 | 针对不同线路，开启/关闭负载均衡。                |



名词解释 
-------------------------

![名词解释](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/4078700161/p211167.png)


| 序号 |   名词    |                        描述                        |
|----|---------|--------------------------------------------------|
| 1  | 负载均衡策略  | 显示当前用户应用的负载均衡策略，负载均衡策略包含返回全部地址、按权重返回地址两种策略方式。    |
| 2  | 返回全部地址  | 指应用服务的域名，同时解析到多个地址，每个IP地址平均承担用户的访问流量。            |
| 3  | 按权重返回地址 | 指应用服务的域名，同时解析到多个地址，每个地址配置不同的权重，使每个地址承担不同比例的访问流量。 |
| 4  | 开启权重    | 此开启权重为全局操作，可通过此功能对子域名下的所有线路同时开启权重设置。             |
| 5  | 关闭权重    | 此关闭权重为全局操作，可通过此功能对子域名下的所有线路同时关闭权重设置。             |
| 6  | 设置权重    | 可通过此功能对某条或不同的解析线路，单独开启与设置权重。                     |



设置方法 
-------------------------

1 . 登录到 [云解析DNS控制台](https://dns.console.aliyun.com/dns/)。

2 . 在域名解析页面，全部域名页签下，单击 **域名** ，进入解析设置页面。

![目录](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/8001232061/p171970.png)

3 . 在解析设置页面，点击左侧导航 **权重配置** ，进入权重配置页面，单击 **开启权重** 按钮，一般开启是默认权重（1:1:1）的配置，在DNS请求应答中，云解析DNS会按照1:1:1的权重策略返回IP地址。
**说明**



开启权重为全局操作，指子域名下的所有线路权重开关全部开启。

![1](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/2204479061/p208730.png)![开启权重-2](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/3204479061/p208733.png)

4 . 在权重配置页面，权重配置页签下，单击 **设置权重** 按钮，配置权重后，在DNS请求应答中，云解析DNS会按照预先设置的权重返回IP地址。

![权重设置](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/3204479061/p208738.png)
**注意**

您也可以单独为某条线路进行权重开启。步骤如下：

单独开启某一线路的权重及设置效果，除了"开启权重"的全局开启操作，您还可以单独为某一线路进行线路权重开启。例如：

1. 子域名的负载均衡策略为"返回全部地址"，点击"设置权重"。

   ![设置权重](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/5078700161/p211173.png)
   

2. 选择要开启权重的线路。

   **说明**

   负载均衡策略为"返回全部地址"且为开启线路权重开关，权重为不可编辑状态。

   ![选择线路](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/5078700161/p211181.png)
   

3. 打开"线路权重开关"，在下方权重列按业务场景需求配置权重值。

   ![开启线路权重](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/5078700161/p211198.png)
   




**实现效果：默认线路按照设置的权重比1:1进行返回，其他线路返回线路下全部地址。** 

实现效果 
-------------------------

* 未开启权重配置的效果

  




假设您有 3 台服务器（IP 地址分别为`1.1.1.1`、`2.2.2.2`、`3.3.3.3`）提供同一服务（1个域名），且在解析设置中对应如下 3 条 A 记录：


| 记录类型 | 主机记录 | 解析线路 |   记录值   |
|------|------|------|---------|
| A    | www  | 默认   | 1.1.1.1 |
| A    | www  | 默认   | 2.2.2.2 |
| A    | www  | 默认   | 3.3.3.3 |



当Local DNS访问云解析DNS， **云解析DNS将这3个解析记录全部返回给Local DNS** ，Local DNS再将所有的IP地址返回给网站访问者，网站访问者的浏览器会随机访问其中一个IP。

在无DNS负载均衡的权威DNS中，这种方法能够在一定程度上减轻单台服务器的压力，但它不能区分服务器的差异，不能反映服务器的当前运行状态。

* 默认权重效果

  




权重配置开启，默认配置的是1:1:1权重， **云解析DNS会根据（默认权重1:1:1），轮询3个A记录，依次返回3个IP地址** ，以响应网站访问者的请求。DNS解析结果如下所示：

    Region1 访问，返回 1.1.1.1
    Region2 访问，返回 2.2.2.2
    Region3 访问，返回 3.3.3.3
    Region4 访问，返回 1.1.1.1
    Region5 访问，返回 2.2.2.2
    Region6 访问，返回 3.3.3.3
    ......



* 权重设置效果

  权重配置 **开启** 后，进行 **权重设置** ，在DNS请求应答中，IP地址按照预先设置的权重进行返回，可以实现将解析流量按照权重进行分配。例如，将上述3条解析记录的权重比设置为2:1:1时，则DNS解析结果如下所示：

  

      Region1 访问，返回 1.1.1.1
      Region2 访问，返回 2.2.2.2
      Region3 访问，返回 3.3.3.3
      Region4 访问，返回 1.1.1.1
      Region5 访问，返回 1.1.1.1
      Region6 访问，返回 2.2.2.2
      ......

  






1.

   





**说明**



如果您在测试过程中，发现偶尔会出现DNS解析结果和权重配置不符的现象，这属于一种正常现象。因为加权轮询是一个粗粒度的解析流量调度方式，它针对的是localdns的请求，而localdns在TTL时间内是只会向权威DNS（云解析DNS）请求一次。

例如您的域名被上海和北京两个地区的用户访问，假设上海用户使用的是localdnsA，北京用户使用到的是localdnsB。 当localdnsA和localdnsB向云解析DNS发起查询请求的时候，云解析DNS会按照用户配置的加权策略返回，但是在TTL时间内，使用相同localdns下的所有用户获取到的都是同一个解析结果。




权重配置 
=========================



概述 
-----------------------

云解析DNS权重配置，指在DNS服务器中为同一个主机记录配置多个IP地址，在应答DNS查询时，所有IP地址按照预先设置的权重进行返回不同的解析结果，将解析流量分配到不同的服务器上，从而达到负载均衡的目的。

启用条件 
-------------------------

权重配置的启用条件是域名下存在相同的主机记录、相同解析线路的多条A记录、CNAME记录、AAAA记录。

规则限制 
-------------------------

权重配置仅适用于记录类型为"A记录、CNAME记录、AAAA记录"，且是 **相同主机记录** 、 **相同线路** 下的\*\*多个记录值。具体使用规则如下：


|    限制    |                                         支持                                          |               不支持                |
|----------|-------------------------------------------------------------------------------------|----------------------------------|
| 记录类型     | A记录、CNAME记录、AAAA记录                                                                  | 其他记录类型                           |
| 记录状态     | 出于 **启用** 状态的记录                                                                     | 处于 **暂停** 、 **锁定** 状态的记录，以及泛解析记录 |
| 解析记录数量限制 | 单域名单线路下允许配置权重的最大解析记录数量：免费版支持10个，付费版支持90个。                                           | ---------                        |
| 权重值规则    | 权重值允许设置0-100，默认权重值比例为1:1 . 支持权重值设置为 "0"，则云解析DNS不返回此解析记录值。                           | ---------                        |
| 解析线路     | 可对默认线路配置带权重的A记录，也可以对具体的线路配置。 **说明**  不同线路中，其权重相互独立。 | 针对不同线路，开启/关闭负载均衡。                |



设置方法 
-------------------------

1 . 登录到 [云解析DNS控制台](https://dns.console.aliyun.com/dns/)。

2 . 在域名解析页面，全部域名页签下，单击 **域名** ，进入解析设置页面。

![目录](//static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/zh-CN/8001232061/p171970.png)

2 . 在解析设置页面，点击左侧导航 **权重配置** ，进入权重配置页面，单击 **开启** 按钮，一般开启是默认权重（1:1:1）的配置，在DNS请求应答中，云解析DNS会按照1:1:1的权重策略返回IP地址。

![开启权重](//static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/zh-CN/8001232061/p171971.png)![开启对话框](//static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/zh-CN/8001232061/p171972.png)

3 . 在权重配置页面，加权轮询页签下，单击 **设置权重** 按钮，配置权重后，在DNS请求应答中，云解析DNS会按照预先设置的权重返回IP地址。

![加权策略](//static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/zh-CN/8001232061/p171973.png)

实现效果 
-------------------------

* 未开启权重配置的效果

  




假设您有 3 台服务器（IP 地址分别为`1.1.1.1`、`2.2.2.2`、`3.3.3.3`）提供同一服务（1个域名），且在解析设置中对应如下 3 条 A 记录：


| 记录类型 | 主机记录 | 解析线路 |   记录值   |
|------|------|------|---------|
| A    | www  | 默认   | 1.1.1.1 |
| A    | www  | 默认   | 2.2.2.2 |
| A    | www  | 默认   | 3.3.3.3 |



当Local DNS访问云解析DNS， **云解析DNS将这3个解析记录全部返回给Local DNS** ，Local DNS再将所有的IP地址返回给网站访问者，网站访问者的浏览器会随机访问其中一个IP。

在无DNS负载均衡的权威DNS中，这种方法能够在一定程度上减轻单台服务器的压力，但它不能区分服务器的差异，不能反映服务器的当前运行状态。

* 默认权重效果

  




权重配置开启，默认配置的是1:1:1权重， **云解析DNS会根据（默认权重1:1:1），轮询3个A记录，依次返回3个IP地址** ，以响应网站访问者的请求。DNS解析结果如下所示：

    Region1 访问，返回 1.1.1.1
    Region2 访问，返回 2.2.2.2
    Region3 访问，返回 3.3.3.3
    Region4 访问，返回 1.1.1.1
    Region5 访问，返回 2.2.2.2
    Region6 访问，返回 3.3.3.3
    ......



* 权重设置效果

  




权重配置 **开启** 后，进行 **权重设置** ，在DNS请求应答中，IP地址按照预先设置的权重进行返回，可以实现将解析流量按照权重进行分配。例如，将上述3条解析记录的权重比设置为2:1:1时，则DNS解析结果如下所示：

    Region1 访问，返回 1.1.1.1
    Region2 访问，返回 2.2.2.2
    Region3 访问，返回 3.3.3.3
    Region4 访问，返回 1.1.1.1
    Region5 访问，返回 1.1.1.1
    Region6 访问，返回 2.2.2.2
    ......


**说明**



如果您在测试过程中，发现偶尔会出现DNS解析结果和权重配置不符的现象，这属于一种正常现象。因为加权轮询是一个粗粒度的解析流量调度方式，它针对的是localdns的请求，而localdns在TTL时间内是只会向权威DNS（云解析DNS）请求一次。

例如您的域名被上海和北京两个地区的用户访问，假设上海用户使用的是localdnsA，北京用户使用到的是localdnsB。 当localdnsA和localdnsB向云解析DNS发起查询请求的时候，云解析DNS会按照用户配置的加权策略返回，但是在TTL时间内，使用相同localdns下的所有用户获取到的都是同一个解析结果。



